name: Build and Test

on:
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: ~/.cache/ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_COMPILERCHECK: content
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: sudo apt update && sudo apt install -y --no-install-recommends valac build-essential meson libglib2.0-dev ninja-build ccache

    - name: Cache ccache
      uses: actions/cache@v5
      with:
        path: ~/.cache/ccache
        key: build-test-ccache-${{ runner.os }}-${{ hashFiles('meson.build', 'src/**/*.vala', 'tests/**/*.vala') }}
        restore-keys: |
          build-test-ccache-${{ runner.os }}-

    - name: Configure build
      run: |
        CC="ccache gcc" meson setup build -Denable_valadoc=false

    - name: Build
      run: |
        ccache --zero-stats || true
        ninja -C build

    - name: Unit Test
      run: meson test -C build --print-errorlogs --num-processes "$(nproc)" --no-rebuild

    - name: Show ccache stats
      if: always()
      run: ccache --show-stats || true
